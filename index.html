<!DOCTYPE html>
<html>
<head>
    <link href="./resources/css/index.css" type="text/css" rel="stylesheet">
    <script src="./resources/js/stocks.js"></script>
    <script src="./resources/js/bundle.js"></script>
    <script src="./resources/js/math.js"></script>
</head>
<body>
    <ul class="nav-bar">
        <li><a href="">Home</a></li>
    </ul>
    <div class="main_text">
        <h1>Hello World</h1>
        <p>Hello my name is Eric! I`m interested in a lot of things. One of those things is below:</p>
    </div>
    <script>
        var assets = ['XSP.TO','XIC.TO','XIN.TO','XBB.TO','CAR-UN.TO']
        var options = {
          symbol: 'AAPL',
          interval: 'weekly',
          amount: 53
        };
        var cov = require( 'compute-covariance' );
        var formatOption = {
                style: 'percent',
                maximumFractionDigits: 2
        };
        var covmatMain = {};
        var remoteMat = {}

        //Fetch static covariance matrix from API
        const url='https://deploy-back-end-example.herokuapp.com/matrix'
        fetch(url)
        .then(data=>{return data.json()})
        .then(data=>{remoteMat=math.matrix(data.data)})
        .then(res=>{console.log(res)})

        const makeReturnArray = (results) => {
            var closeArray = [];
            var returnArray = [];
            for (var p in results) {
                tArray = [];
                rArray = [];
                for (var d in results[p]){
                    console.log(assets[p])
                    tArray.push(results[p][d].close)
                    if (d < 52) {
                        let ld = 0;
                        ld = Number(d) + 1;                   //Latest date placed at start of array.
                        rArray.push((results[p][d].close-results[p][ld].close)/(results[p][ld].close))
                    }
                };
                closeArray[p] = tArray;
                returnArray[p] = rArray;
            }
            return returnArray;
        };
        
        const closeP = (results) => {
            var closeArray = [];
            for (var p in results) {
                tArray = [];
                for (var d in results[p]){
                    tArray.push(results[p][d].close)    
                }
                closeArray[p] = tArray;
            }
            return closeArray;
        };

        const updateHurdle = () =>{
            tWeight = math.transpose(weight);
            risk = math.sqrt(math.multiply(weight,covmat,tWeight))*math.sqrt(52)
            gradient = math.multiply(weight,covmat,52,1/risk)
            ed = snp500ret.value/100/gradient._data[0]

            document.getElementById("conventional-hurdle-rate-s&ptsx").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[1])
            document.getElementById("conventional-hurdle-rate-eafe").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[2])
            document.getElementById("conventional-hurdle-rate-canadianbonds").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[3])
            document.getElementById("conventional-hurdle-rate-careit").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[4])

            customWeight = [snp500w.value/100, w1.value/100, w2.value/100, w3.value/100, w4.value/100];
            tCustomWeight = math.transpose(customWeight);
            customRisk = math.sqrt(math.multiply(customWeight,covmatMain,tCustomWeight))*math.sqrt(52)
            customGradient = math.multiply(customWeight,covmatMain,52,1/customRisk)
            customEd = snp500ret.value/100/customGradient._data[0]
            
            document.getElementById("custom-hurdle-rate-s&p").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[0])
            document.getElementById("custom-hurdle-rate-s&ptsx").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[1])
            document.getElementById("custom-hurdle-rate-eafe").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[2])
            document.getElementById("custom-hurdle-rate-canadianbonds").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[3])
            document.getElementById("custom-hurdle-rate-careit").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[4])
            }

        const getStockData = async assets => {

            //Download stock data
            var results = [];
            var stocks = new Stocks('HOW0LDN2HBFLZDA2')
            for (a in assets) {
                options.symbol = assets[a];
                results[a] = await stocks.timeSeries(options)
            }
            let returnResults = results;
            closePrice = closeP(await returnResults);
            returns=makeReturnArray(await returnResults);
            covmat=math.matrix(cov(returns));

            //Use the static matrix from the Heroku server if possible
            console.log(remoteMat)
            if (remoteMat !== undefined) {
                covmat = remoteMat;
            }
            weight = [0.2, 0.2, 0.2, 0.35, 0];
            tWeight = math.transpose(weight);
            risk = math.sqrt(math.multiply(weight,covmat,tWeight))*math.sqrt(52)
            gradient = math.multiply(weight,covmat,52,1/risk)
            ed = snp500ret.value/100/gradient._data[0]
            hurdle = [];
            for (var g of gradient._data){
                hurdle.push(ed*g);
            } 
            hurdle[0]=snp500ret.value/100;
            console.log(hurdle);        
            console.log(returns);
            document.getElementById("conventional-hurdle-rate-s&ptsx").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[1])
            document.getElementById("conventional-hurdle-rate-eafe").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[2])
            document.getElementById("conventional-hurdle-rate-canadianbonds").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[3])
            document.getElementById("conventional-hurdle-rate-careit").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(ed*gradient._data[4])

            customWeight = [snp500w.value/100, w1.value/100, w2.value/100, w3.value/100, w4.value/100];
            tCustomWeight = math.transpose(customWeight);
            customRisk = math.sqrt(math.multiply(customWeight,covmat,tCustomWeight))*math.sqrt(52)
            customGradient = math.multiply(customWeight,covmat,52,1/customRisk)
            customEd = snp500ret.value/100/customGradient._data[0]

            document.getElementById("custom-hurdle-rate-s&p").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[0])            
            document.getElementById("custom-hurdle-rate-s&ptsx").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[1])
            document.getElementById("custom-hurdle-rate-eafe").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[2])
            document.getElementById("custom-hurdle-rate-canadianbonds").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[3])
            document.getElementById("custom-hurdle-rate-careit").innerHTML=Intl.NumberFormat("en-CA",formatOption).format(customEd*customGradient._data[4])
            
            covmatMain = covmat;

            return gradient._data;
        }

        var hurdleGradient=getStockData(assets)

    </script>
        <div class="hurdle-rates-table">
            <h2>Expected Returns Calculator</h2>
            <h3>How this works</h3>
            <p>This calculator takes a set of investible indices, weights of those indices inside a portfolio, and some portfolio assumptions (see below) to back out the Expected Returns assumptions behind that portfolio.</p>  
            <P>I calculate a set of expected returns for a "conventional" or "60/40 Equities/Bonds" investment portfolio in the 3rd column. You can supply different weights of the same investible indices, and compare how your expected returns differ.</P>
            <p><bold>*WARNING*</bold> None of this is investing advice. Forecasting and calculating expected returns is a notoriously difficult process; the results from the calculator below are only valid under certain assumptions (see below).</p>
            <table>
                <tr>
                    <td>Asset Class / Investible Index</td>
                    <td>"Conventional" Weight</td>
                    <td>"Conventional" Expected Return</td>
                    <td>Weight in your portfolio (%)</td>
                    <td>Your Expected Return</td>
                </tr>
                <tr>
                    <td>S&P 500</td>
                    <td>20%</td>
                    <td><input type="number" id="snp500ret" name="snp500ret" min="0" max="100" step="0.01" value="5.00"></td>
                    <td><input type="number" id="snp500w" name="snp500w" min="0" max="100" step="1" value="20"></td>
                    <td id="custom-hurdle-rate-s&p"></td>
                </tr>
                <tr>
                    <td>S&P TSX</td>
                    <td>20%</td>
                    <td id="conventional-hurdle-rate-s&ptsx"></td>
                    <td><input type="number" id="w1" name="w1" min="0" max="100" step="1" value="20"></td>
                    <td id="custom-hurdle-rate-s&ptsx"></td>
                </tr>
                <tr>
                    <td>EAFE Equities</td>
                    <td>20%</td>
                    <td id="conventional-hurdle-rate-eafe"></td>
                    <td><input type="number" id="w2" name="w2" min="0" max="100" step="1" value="20"></td>
                    <td id="custom-hurdle-rate-eafe"></td>
                </tr>
                <tr>
                    <td>Canadian Bond Universe</td>
                    <td>40%</td>
                    <td id="conventional-hurdle-rate-canadianbonds"></td>
                    <td><input type="number" id="w3" name="w3" min="0" max="100" step="1" value="35"></td>
                    <td id="custom-hurdle-rate-canadianbonds"></td>
                </tr>
                <tr>
                    <td>Canadian Apartments Reit</td>
                    <td>0%</td>
                    <td id="conventional-hurdle-rate-careit"></td>
                    <td><input type="number" id="w4" name="w4" min="0" max="100" step="1" value="5"></td>
                    <td id="custom-hurdle-rate-careit"></td>
                </tr>
            </table>
        </div>
    </div>
    <h3>How this works (long version)</h3>
    <p>
        This calculator follows the logic outlined in 
        <a href="https://www.amazon.ca/Modern-Investment-Management-Equilibrium-Approach/dp/0471124109">
        "Modern Investment Management: An Equilibrium Approach"</a> by Bob Litterman.
        It assumes that any assets in any "optimal" portfolio must have the same ratio
         of expected returns to marginal increase in risk ("ER/MCR" ratio). If this ratio is different
          for different assets, you can change the weight of any asset to increase total portfolio
           expected returns or portfolio risk.
    </p>
    <p>
        We back out the expected returns of particular assets in the portfolio by calculating the
         ER/MCR ratio for one asset (in this case S&P 500) with an assumed risk premium (in this case,
          5%; you can change this). Then we equalize the ER/MCR ratio for all assets, and back out
           their expected returns by multiplying those ratios by their individual MCR values.</p>
    <h4>Key Assumptions:</h4>
    <ul>
        <li>
            You only care about returns and risk (standard deviation of risk) in an "optimal" 
            portfolio
        </li>
        <li>
            Recent historical returns (unweighted data from last 52 weeks) are adequte to estimate
            marginal increase in portfolio risk
        </li>
        <li>
            We can use the historical covariance matrix as the risk model to estimate marginal 
            increase in portfolio risk
        </li>
        <li>
            The initial expected return we supplied (S&P 500) is relatively accurate
        </li>
    </ul>
    <h4>Technologies used:</h4>
    <ul>
        <li><a href="https://github.com/wagenaartje/stocks.js">stock.js</a> to download securities data</li>
        <li><a href="https://github.com/compute-io/covariance">compute-covariance</a> to compute covariance matrices</li>
        <li><a href="https://mathjs.org/index.html">math.js</a> to perform matrix algebra</li>
    </ul>
    <script>
        snp500ret.addEventListener('change',updateHurdle)
        snp500w.addEventListener('change',updateHurdle)
        w1.addEventListener('change',updateHurdle)
        w2.addEventListener('change',updateHurdle)
        w3.addEventListener('change',updateHurdle)
        w4.addEventListener('change',updateHurdle)
</script>
</body>
</html>