<!DOCTYPE html>
<html>
<head>
    
    <link rel="stylesheet" href="https://unpkg.com/chota@latest">
    <link href="./resources/css/index.css" type="text/css" rel="stylesheet">
    <script src="./resources/js/stocks.js"></script>
    <script src="./resources/js/bundle.js"></script>
    <script src="./resources/js/math.js"></script>
    <script src="./resources/js/closeprice.js"></script>
    <script src="./resources/js/makereturnarray.js"></script>
    <script src="./resources/js/portfoliorisk.js"></script>
    <script src="./resources/js/getmatrixdata.js"></script>
</head>
<body>
    <ul class="nav-bar">
        <li><a href="">Home</a></li>
    </ul>
    <div class="main_text">
        <h1>Hello World</h1>
        <p>Hello my name is Eric! I`m interested in a lot of things. One of those things is below:</p>
    </div>
        <div class="hurdle-rates-table">
            <h2>Expected Returns Calculator</h2>
            <h3>How this works</h3>
            <p>This calculator takes a set of investible indices, weights of those indices inside a portfolio, and some portfolio assumptions (see below) to back out the Expected Returns assumptions behind that portfolio.</p>  
            <P>I calculate a set of expected returns for a "conventional" or "60/40 Equities/Bonds" investment portfolio in the 3rd column. You can supply different weights of the same investible indices, and compare how your expected returns differ.</P>
            <p><bold>*WARNING*</bold> None of this is investing advice. Forecasting and calculating expected returns is a notoriously difficult process; the results from the calculator below are only valid under certain assumptions (see below).</p>
            <table>
                <tr>
                    <td>Asset Class / Investible Index</td>
                    <td>"Conventional" Weight</td>
                    <td>"Conventional" Expected Return</td>
                    <td>Weight in your portfolio (%)</td>
                    <td>Your Expected Return</td>
                </tr>
                <tr>
                    <td>S&P 500</td>
                    <td>20%</td>
                    <td><input type="number" id="snp500ret" name="snp500ret" min="0" max="100" step="0.01" value="5.00"></td>
                    <td><input type="number" id="snp500w" name="snp500w" min="0" max="100" step="1" value="20"></td>
                    <td id="custom-hurdle-rate-s&p"></td>
                </tr>
                <tr>
                    <td>S&P TSX</td>
                    <td>20%</td>
                    <td id="conventional-hurdle-rate-s&ptsx"></td>
                    <td><input type="number" id="w1" name="w1" min="0" max="100" step="1" value="20"></td>
                    <td id="custom-hurdle-rate-s&ptsx"></td>
                </tr>
                <tr>
                    <td>EAFE Equities</td>
                    <td>20%</td>
                    <td id="conventional-hurdle-rate-eafe"></td>
                    <td><input type="number" id="w2" name="w2" min="0" max="100" step="1" value="20"></td>
                    <td id="custom-hurdle-rate-eafe"></td>
                </tr>
                <tr>
                    <td>Canadian Bond Universe</td>
                    <td>40%</td>
                    <td id="conventional-hurdle-rate-canadianbonds"></td>
                    <td><input type="number" id="w3" name="w3" min="0" max="100" step="1" value="35"></td>
                    <td id="custom-hurdle-rate-canadianbonds"></td>
                </tr>
                <tr>
                    <td>Canadian Apartments Reit</td>
                    <td>0%</td>
                    <td id="conventional-hurdle-rate-careit"></td>
                    <td><input type="number" id="w4" name="w4" min="0" max="100" step="1" value="5"></td>
                    <td id="custom-hurdle-rate-careit"></td>
                </tr>
            </table>
        </div>
    </div>
    <h3>How this works (long version)</h3>
    <p>
        This calculator follows the logic outlined in 
        <a href="https://www.amazon.ca/Modern-Investment-Management-Equilibrium-Approach/dp/0471124109">
        "Modern Investment Management: An Equilibrium Approach"</a> by Bob Litterman.
        It assumes that any assets in any "optimal" portfolio must have the same ratio
         of expected returns to marginal increase in risk ("ER/MCR" ratio). If this ratio is different
          for different assets, you can change the weight of any asset to increase total portfolio
           expected returns or portfolio risk.
    </p>
    <p>
        We back out the expected returns of particular assets in the portfolio by calculating the
         ER/MCR ratio for one asset (in this case S&P 500) with an assumed risk premium (in this case,
          5%; you can change this). Then we equalize the ER/MCR ratio for all assets, and back out
           their expected returns by multiplying those ratios by their individual MCR values.</p>
    <h4>Key Assumptions:</h4>
    <ul>
        <li>
            You only care about returns and risk (standard deviation of risk) in an "optimal" 
            portfolio
        </li>
        <li>
            Recent historical returns (unweighted data from last 52 weeks) are adequte to estimate
            marginal increase in portfolio risk
        </li>
        <li>
            We can use the historical covariance matrix as the risk model to estimate marginal 
            increase in portfolio risk
        </li>
        <li>
            The initial expected return we supplied (S&P 500) is relatively accurate
        </li>
    </ul>
    <h4>Technologies used:</h4>
    <ul>
        <li><a href="https://github.com/wagenaartje/stocks.js">stock.js</a> to download securities data</li>
        <li><a href="https://github.com/compute-io/covariance">compute-covariance</a> to compute covariance matrices</li>
        <li><a href="https://mathjs.org/index.html">math.js</a> to perform matrix algebra</li>
    </ul>
    <script>
                var assets = ['XSP.TO','XIC.TO','XIN.TO','XBB.TO','CAR-UN.TO']
        var options = {
          symbol: 'AAPL',
          interval: 'weekly',
          amount: 53
        };
        var cov = require( 'compute-covariance' );
        var formatOption = {
                style: 'percent',
                maximumFractionDigits: 2
        };
        var covmatMain = {};
        var remoteMat = {}
        const conventionalReturnElements = [
                "conventional-hurdle-rate-s&ptsx",
                "conventional-hurdle-rate-eafe",
                "conventional-hurdle-rate-canadianbonds",
                "conventional-hurdle-rate-careit"
        ];
        const customReturnElements = [
                "custom-hurdle-rate-s&p",
                "custom-hurdle-rate-s&ptsx",
                "custom-hurdle-rate-eafe",
                "custom-hurdle-rate-canadianbonds",
                "custom-hurdle-rate-careit"
        ];

        let weight = [0.2, 0.2, 0.2, 0.35, 0];
        let customWeight = [snp500w.value/100, w1.value/100, w2.value/100, w3.value/100, w4.value/100];        

        //Fetch static covariance matrix from API
        const url='https://deploy-back-end-example.herokuapp.com/matrix'
        fetch(url)
        .then(data=>{return data.json()})
        .then(data=>{remoteMat=math.matrix(data.data)})
        .then(res=>{console.log(res)})

        const updateHurdle = () => {
            let weight = [0.2, 0.2, 0.2, 0.35, 0];
            let customWeight = [snp500w.value/100, w1.value/100, w2.value/100, w3.value/100, w4.value/100];        
            portConventional = portfolioRisk(covmatMain,snp500ret.value,weight,52,100)
            portCustom = portfolioRisk(covmatMain,snp500ret.value,customWeight,52,100)

            elements1 = conventionalReturnElements;
            elements2 = customReturnElements;
            port1 = portConventional;
            port2 = portCustom;

            let conventionalGradient = port1.ERMCratios._data.slice(1)
            for (var e in elements1) {
                document.getElementById(elements1[e]).innerHTML=Intl.NumberFormat("en-CA",formatOption).format(port1.anchorERMC*port1.ERMCratios._data.slice(1)[e])
            }
            for (var e in elements2) {
                document.getElementById(elements2[e]).innerHTML=Intl.NumberFormat("en-CA",formatOption).format(port2.anchorERMC*port2.ERMCratios._data[e])
            }
        }

        getMatrixData(assets)
        .then(matrix=>{
            covmatMain=matrix
            portConventional = portfolioRisk(covmatMain,snp500ret.value,weight,52,100)
            portCustom = portfolioRisk(covmatMain,snp500ret.value,customWeight,52,100)
            let conventionalGradient = portConventional.ERMCratios._data.slice(1)
            for (var e in conventionalReturnElements) {
                document.getElementById(conventionalReturnElements[e]).innerHTML=Intl.NumberFormat("en-CA",formatOption).format(portConventional.anchorERMC*portConventional.ERMCratios._data.slice(1)[e])
            }

            for (var e in customReturnElements) {
                document.getElementById(customReturnElements[e]).innerHTML=Intl.NumberFormat("en-CA",formatOption).format(portCustom.anchorERMC*portCustom.ERMCratios._data[e])
            }
            console.log(conventionalReturnElements,customReturnElements,portConventional,portCustom)
            snp500ret.addEventListener('change',updateHurdle)
            snp500w.addEventListener('change',updateHurdle)
            w1.addEventListener('change',updateHurdle)
            w2.addEventListener('change',updateHurdle)
            w3.addEventListener('change',updateHurdle)
            w4.addEventListener('change',updateHurdle)
        })

    </script>
</body>
</html>